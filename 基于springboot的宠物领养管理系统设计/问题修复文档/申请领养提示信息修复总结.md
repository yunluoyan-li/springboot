# 申请领养提示信息修复总结

## 问题描述

用户反馈：有时候点击申请领养的时候会跳回宠物列表界面，因为该宠物已经被申请领养，但是没有提示信息告知用户具体原因。

## 问题分析

通过代码分析发现，在 `AdoptionApplicationController.java` 的 `showApplyForm` 方法中，当检测到用户已经申请过该宠物时，代码使用了 `model.addAttribute("error", "您已经申请过这个宠物了")` 然后重定向到 `/pets/list`。

**问题所在**：重定向会丢失 Model 中的属性，所以错误信息不会显示在宠物列表页面上。

## 解决方案

### 1. 修改控制器方法

将 `showApplyForm` 方法的参数从 `Model model` 改为 `RedirectAttributes redirectAttributes`，并使用 `addFlashAttribute` 方法传递错误信息。

**修改前：**
```java
@GetMapping("/apply/{petId}")
public String showApplyForm(@PathVariable Long petId, Model model, HttpSession session) {
    // ...
    if (adoptionApplicationService.hasUserAppliedForPet(userId, petId)) {
        model.addAttribute("error", "您已经申请过这个宠物了");
        return "redirect:/pets/list";
    }
    // ...
}
```

**修改后：**
```java
@GetMapping("/apply/{petId}")
public String showApplyForm(@PathVariable Long petId, Model model, HttpSession session, RedirectAttributes redirectAttributes) {
    // ...
    if (adoptionApplicationService.hasUserAppliedForPet(userId, petId)) {
        redirectAttributes.addFlashAttribute("error", "该宠物已经被申请领养了");
        return "redirect:/pets/list";
    }
    // ...
}
```

### 2. 错误信息优化

将错误信息从"您已经申请过这个宠物了"改为"该宠物已经被申请领养了"，更加清晰地说明情况。

### 3. 其他相关修复

同时修复了其他重定向场景中的错误信息传递：

- 宠物不存在时的错误信息
- 系统异常时的错误信息

## 技术要点

### RedirectAttributes vs Model

- **Model**: 用于直接渲染页面时传递数据，重定向时会丢失
- **RedirectAttributes**: 专门用于重定向时传递数据，使用 Flash Attributes 机制

### Flash Attributes 机制

Flash Attributes 是 Spring MVC 提供的一种在重定向之间传递数据的机制：
- 数据存储在 Session 中
- 重定向后自动从 Session 中移除
- 适合传递一次性消息（如错误信息、成功提示）

## 验证方法

1. 用户登录系统
2. 对某个宠物提交申请
3. 再次尝试申请同一个宠物
4. 应该看到错误提示："该宠物已经被申请领养了"

## 文件修改清单

- `src/main/java/com/example/petadoption/controller/AdoptionApplicationController.java`
  - 修改 `showApplyForm` 方法参数
  - 使用 `RedirectAttributes` 替代 `Model` 传递错误信息
  - 优化错误信息文本

## 影响范围

- ✅ 修复了申请领养时的错误提示问题
- ✅ 提升了用户体验
- ✅ 不影响其他功能的正常运行
- ✅ 保持了代码的一致性和可维护性

## 总结

通过使用 `RedirectAttributes` 替代 `Model` 来传递重定向时的错误信息，成功解决了用户申请领养时缺少提示信息的问题。这个修复提升了系统的用户体验，让用户能够清楚地了解为什么申请被拒绝。 