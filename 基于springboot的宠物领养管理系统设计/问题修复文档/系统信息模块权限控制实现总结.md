# 系统信息模块权限控制实现总结

## 功能概述

成功实现了只有管理员能够访问系统信息模块的权限控制功能，包括：

1. **后端权限控制** - 在API层面进行权限验证
2. **前端权限控制** - 在UI层面隐藏非管理员功能
3. **传统页面权限控制** - 在Thymeleaf模板中进行权限检查

## 实现细节

### 1. 后端权限控制

#### 1.1 传统MVC控制器权限控制
**文件**: `src/main/java/com/example/petadoption/controller/SystemController.java`

```java
@GetMapping("/info")
public String showSystemInfo(Model model, HttpSession session, RedirectAttributes redirectAttributes) {
    // 检查用户是否登录
    Long userId = (Long) session.getAttribute("userId");
    if (userId == null) {
        redirectAttributes.addFlashAttribute("error", "请先登录");
        return "redirect:/login";
    }
    
    // 检查用户角色
    String userRole = (String) session.getAttribute("userRole");
    if (!"ADMIN".equals(userRole)) {
        redirectAttributes.addFlashAttribute("error", "权限不足，只有管理员可以访问系统信息");
        return "redirect:/main";
    }
    
    // 构建系统信息...
    return "system/info";
}
```

#### 1.2 RESTful API权限控制
**文件**: `src/main/java/com/example/petadoption/controller/api/SystemApiController.java`

```java
@GetMapping("/info")
public ResponseEntity<Map<String, Object>> getSystemInfo(HttpSession session) {
    // 检查用户是否登录
    Long userId = (Long) session.getAttribute("userId");
    if (userId == null) {
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(errorResponse);
    }
    
    // 检查用户角色
    String userRole = (String) session.getAttribute("userRole");
    if (!"ADMIN".equals(userRole)) {
        return ResponseEntity.status(HttpStatus.FORBIDDEN).body(errorResponse);
    }
    
    // 返回系统信息...
}
```

### 2. 前端权限控制

#### 2.1 传统Thymeleaf页面权限控制
**文件**: `src/main/resources/templates/main.html`

```html
<li class="nav-item" th:if="${session.userRole == 'ADMIN'}">
    <a class="nav-link" href="/system/info">
        <i class="bi bi-info-circle me-2"></i> 系统信息
    </a>
</li>
```

#### 2.2 前端SPA权限控制
**文件**: `frontend/index.html`

```html
<li class="nav-item admin-only" style="display: none;">
    <a class="nav-link" href="#" onclick="showSystemInfo()">
        <i class="fas fa-info-circle me-1"></i>系统信息
    </a>
</li>
```

**文件**: `frontend/js/app.js`

```javascript
// 显示系统信息（管理员）
async function showSystemInfo() {
    if (!currentUser || currentUser.role !== 'ADMIN') {
        Utils.showMessage('权限不足', '只有管理员可以查看系统信息', 'error');
        return;
    }
    
    hideAllSections();
    document.getElementById('systemInfoSection').style.display = 'block';
    
    try {
        const response = await SystemAPI.getSystemInfo();
        if (response.success) {
            renderSystemInfo(response.systemInfo);
        }
    } catch (error) {
        Utils.showMessage('加载失败', error.message, 'error');
    }
}
```

### 3. API接口实现

#### 3.1 系统信息API
**文件**: `frontend/js/api.js`

```javascript
// 系统信息相关API
const SystemAPI = {
    // 获取系统信息（管理员）
    getSystemInfo: async () => {
        return apiRequest('/api/system/info');
    }
};
```

#### 3.2 系统信息内容渲染
```javascript
function renderSystemInfo(systemInfo) {
    // 渲染基本信息
    // 渲染内存使用情况
    // 渲染路径信息
    // 包含进度条显示内存使用率
}
```

## 权限控制机制

### 1. 多层权限验证

1. **前端UI层** - 根据用户角色显示/隐藏功能
2. **前端逻辑层** - JavaScript函数中进行权限检查
3. **后端API层** - 服务器端进行权限验证
4. **后端页面层** - 传统MVC页面进行权限检查

### 2. 权限检查流程

```
用户访问系统信息
    ↓
前端检查用户角色
    ↓
调用API接口
    ↓
后端验证用户登录状态
    ↓
后端验证用户角色
    ↓
返回系统信息或错误
```

### 3. 错误处理

- **401 Unauthorized** - 用户未登录
- **403 Forbidden** - 用户权限不足
- **500 Internal Server Error** - 服务器内部错误

## 系统信息内容

### 1. 基本信息
- 系统版本
- 构建日期
- Java版本
- 操作系统信息
- 系统架构
- 文件编码

### 2. 内存信息
- 总内存
- 已用内存
- 空闲内存
- 最大内存
- 内存使用率（进度条显示）

### 3. 路径信息
- 用户目录
- 工作目录
- Java目录
- 时区信息

## 测试验证

### 1. 管理员用户测试
- ✅ 可以看到系统信息导航链接
- ✅ 可以成功访问系统信息页面
- ✅ 可以查看完整的系统信息

### 2. 普通用户测试
- ❌ 看不到系统信息导航链接
- ❌ 无法访问系统信息页面
- ❌ API返回403权限错误

### 3. 未登录用户测试
- ❌ 无法访问系统信息页面
- ❌ API返回401未授权错误

## 安全考虑

### 1. 权限验证
- 所有系统信息访问都需要验证用户身份
- 只有ADMIN角色的用户才能访问
- 前端和后端双重验证

### 2. 信息保护
- 系统信息包含敏感的系统路径信息
- 只有管理员可以查看，保护系统安全
- 避免信息泄露给普通用户

### 3. 错误处理
- 友好的错误提示信息
- 详细的日志记录
- 防止信息泄露

## 总结

成功实现了系统信息模块的完整权限控制：

1. **后端权限控制** - 在API和页面层面都进行了权限验证
2. **前端权限控制** - 在UI和逻辑层面都进行了权限检查
3. **用户体验** - 提供了友好的错误提示和界面反馈
4. **安全性** - 多层权限验证，确保只有管理员可以访问
5. **功能完整性** - 提供了丰富的系统信息展示

这个实现确保了系统信息模块的安全性，同时提供了良好的用户体验。 